// This is your Prisma schema file

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

// ============= ENUMS =============

enum UserRole {
    ADMIN
    STAFF
    DELIVERY
    CUSTOMER
}

enum UserStatus {
    ACTIVE
    INACTIVE
    SUSPENDED
}

enum ProductCategory {
    HAIR_OIL
    SHAMPOO
    GROWTH_SERUM
    HAIR_BUNDLE
    CONDITIONER
    TREATMENT
}

enum ProductStatus {
    ACTIVE
    INACTIVE
    OUT_OF_STOCK
    DISCONTINUED
}

enum OrderStatus {
    PENDING
    CONFIRMED
    PROCESSING
    ASSIGNED
    OUT_FOR_DELIVERY
    DELIVERED
    CANCELLED
    FAILED
    REFUNDED
}

enum PaymentMethod {
    MOBILE_MONEY
    ORANGE_MONEY
    CASH_ON_DELIVERY
}

enum PaymentStatus {
    PENDING
    COMPLETED
    FAILED
    REFUNDED
}

enum DiscountType {
    PERCENTAGE
    FIXED_AMOUNT
}

enum NotificationType {
    EMAIL
    WHATSAPP
    SMS
}

enum NotificationStatus {
    PENDING
    SENT
    FAILED
}

// ============= USER MANAGEMENT =============

model User {
    id            String     @id @default(auto()) @map("_id") @db.ObjectId
    email         String     @unique
    phone         String     @unique
    password      String
    firstName     String
    lastName      String
    role          UserRole   @default(CUSTOMER)
    status        UserStatus @default(ACTIVE)
    emailVerified Boolean    @default(false)
    phoneVerified Boolean    @default(false)

    // Relations
    addresses      Address[]
    orders         Order[]
    cart           Cart?
    reviews        Review[]
    wishlist       WishlistItem[]
    assignedOrders Order[]        @relation("DeliveryPersonnel")
    refreshTokens  RefreshToken[]

    // Delivery personnel specific
    deliveryZone String?
    vehicleType  String?

    // Metadata
    lastLoginAt DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    deletedAt   DateTime?

    

    @@index([role])
    @@index([status])
    @@map("users")
}

model RefreshToken {
    id        String   @id @default(auto()) @map("_id") @db.ObjectId
    token     String   @unique
    userId    String   @db.ObjectId
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    expiresAt DateTime
    createdAt DateTime @default(now())

    @@index([userId])
    @@map("refresh_tokens")
}

model Address {
    id     String @id @default(auto()) @map("_id") @db.ObjectId
    userId String @db.ObjectId
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    fullName   String
    phone      String
    street     String
    city       String
    region     String
    postalCode String?
    landmark   String?
    isDefault  Boolean @default(false)

    orders Order[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([isDefault])
    @@map("addresses")
}

// ============= PRODUCT CATALOG =============

model Product {
    id               String          @id @default(auto()) @map("_id") @db.ObjectId
    sku              String          @unique
    name             String
    slug             String          @unique
    description      String
    shortDescription String?
    category         ProductCategory
    status           ProductStatus   @default(ACTIVE)

    // Pricing
    price          Float
    compareAtPrice Float?
    cost           Float?

    // Inventory
    stockQuantity     Int     @default(0)
    lowStockThreshold Int     @default(10)
    trackInventory    Boolean @default(true)

    // Product details
    weight       Float?
    volume       Float?
    bundleLength String?

    // Media
    images        ProductImage[]
    featuredImage String?

    // SEO
    metaTitle       String?
    metaDescription String?

    // Relations
    cartItems     CartItem[]
    orderItems    OrderItem[]
    reviews       Review[]
    wishlistItems WishlistItem[]

    // Metadata
    viewCount  Int     @default(0)
    salesCount Int     @default(0)
    featured   Boolean @default(false)

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    deletedAt DateTime?

    @@index([category])
    @@index([status])
    @@index([featured])
    @@map("products")
}

model ProductImage {
    id        String  @id @default(auto()) @map("_id") @db.ObjectId
    productId String  @db.ObjectId
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    url      String
    altText  String?
    position Int     @default(0)

    createdAt DateTime @default(now())

    @@index([productId])
    @@map("product_images")
}

// ============= SHOPPING CART =============

model Cart {
    id     String @id @default(auto()) @map("_id") @db.ObjectId
    userId String @db.ObjectId @unique
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    items CartItem[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("carts")
}

model CartItem {
    id        String @id @default(auto()) @map("_id") @db.ObjectId
    cartId    String @db.ObjectId
    cart      Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)
    productId String @db.ObjectId
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    quantity Int   @default(1)
    price    Float

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([cartId, productId])
    @@index([cartId])
    @@index([productId])
    @@map("cart_items")
}

// ============= ORDERS =============

model Order {
    id          String @id @default(auto()) @map("_id") @db.ObjectId
    orderNumber String @unique

    // Customer
    userId String @db.ObjectId
    user   User   @relation(fields: [userId], references: [id])

    // Delivery
    addressId           String  @db.ObjectId
    address             Address @relation(fields: [addressId], references: [id])
    deliveryPersonnelId String? @db.ObjectId
    deliveryPersonnel   User?   @relation("DeliveryPersonnel", fields: [deliveryPersonnelId], references: [id])
    deliveryFee         Float
    deliveryNotes       String?

    // Pricing
    subtotal Float
    discount Float @default(0)
    total    Float

    // Discount
    discountCodeId String? @db.ObjectId
    discountCode   DiscountCode? @relation(fields: [discountCodeId], references: [id])

    // Payment
    paymentMethod    PaymentMethod
    paymentStatus    PaymentStatus @default(PENDING)
    paymentReference String?
    paidAt           DateTime?

    // Order status
    status OrderStatus @default(PENDING)

    // Items
    items OrderItem[]

    // Status tracking
    statusHistory OrderStatusHistory[]

    // Notifications
    emailSent    Boolean @default(false)
    whatsappSent Boolean @default(false)

    // Notes
    customerNotes String?
    adminNotes    String?

    // Timestamps
    confirmedAt DateTime?
    assignedAt  DateTime?
    deliveredAt DateTime?
    cancelledAt DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([status])
    @@index([paymentStatus])
    @@index([deliveryPersonnelId])
    @@index([createdAt])
    @@map("orders")
}

model OrderItem {
    id        String @id @default(auto()) @map("_id") @db.ObjectId
    orderId   String @db.ObjectId
    order     Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
    productId String @db.ObjectId
    product   Product @relation(fields: [productId], references: [id])

    // Snapshot data
    productName  String
    productSku   String
    productImage String?

    quantity Int
    price    Float
    subtotal Float

    createdAt DateTime @default(now())

    @@index([orderId])
    @@index([productId])
    @@map("order_items")
}

model OrderStatusHistory {
    id      String @id @default(auto()) @map("_id") @db.ObjectId
    orderId String @db.ObjectId
    order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

    status    OrderStatus
    notes     String?
    changedBy String?

    createdAt DateTime @default(now())

    @@index([orderId])
    @@index([createdAt])
    @@map("order_status_history")
}

// ============= DISCOUNTS =============

model DiscountCode {
    id          String  @id @default(auto()) @map("_id") @db.ObjectId
    code        String  @unique
    description String?

    type  DiscountType
    value Float

    // Usage limits
    maxUses        Int?
    usedCount      Int  @default(0)
    maxUsesPerUser Int? @default(1)

    // Constraints
    minPurchaseAmount Float?

    // Validity
    startDate DateTime
    endDate   DateTime
    isActive  Boolean  @default(true)

    // Relations
    orders Order[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt


    @@index([isActive])
    @@index([startDate, endDate])
    @@map("discount_codes")
}

// ============= REVIEWS =============

model Review {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    userId String @db.ObjectId
    user   User   @relation(fields: [userId], references: [id])

    productId String @db.ObjectId
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    rating  Int
    title   String?
    comment String

    isVerified Boolean @default(false)
    isApproved Boolean @default(false)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([userId, productId])
    @@index([productId])
    @@index([isApproved])
    @@index([rating])
    @@map("reviews")
}

// ============= WISHLIST =============

model WishlistItem {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    userId String @db.ObjectId
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    productId String @db.ObjectId
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())

    @@unique([userId, productId])
    @@index([userId])
    @@index([productId])
    @@map("wishlist_items")
}

// ============= NOTIFICATIONS =============

model NotificationLog {
    id String @id @default(auto()) @map("_id") @db.ObjectId

    type   NotificationType
    status NotificationStatus @default(PENDING)

    recipient String
    subject   String?
    message   String

    orderId String? @db.ObjectId

    error  String?
    sentAt DateTime?

    createdAt DateTime @default(now())

    @@index([type])
    @@index([status])
    @@index([orderId])
    @@index([createdAt])
    @@map("notification_logs")
}

// ============= SYSTEM =============

model SystemSettings {
    id          String  @id @default(auto()) @map("_id") @db.ObjectId
    key         String  @unique
    value       String
    description String?

    updatedAt DateTime @updatedAt

    @@map("system_settings")
}

model DailyMetrics {
    id   String   @id @default(auto()) @map("_id") @db.ObjectId
    date DateTime @unique

    totalOrders  Int   @default(0)
    totalRevenue Float @default(0)
    totalProfit  Float @default(0)

    newCustomers Int @default(0)
    productViews Int @default(0)

    createdAt DateTime @default(now())

    
    @@map("daily_metrics")
}